/**
 * Memora AI - Firestore Security Rules
 *
 * Core Philosophy:
 * This ruleset enforces a membership-based security model for the Memora AI platform.
 * All access is denied by default and must be explicitly granted.
 *
 * Data Structure:
 * - /users/{userId}: Global user profiles with list of spaces they belong to.
 * - /spaces/{spaceId}: Collaborative areas (knowledge containers).
 * - /spaces/{spaceId}/members/{userId}: User's membership and profile within a space.
 * - /spaces/{spaceId}/entries/{entryId}: Knowledge entries from Add, Help, Chat tabs.
 * - /spaces/{spaceId}/summaries/{summaryId}: AI-generated knowledge summaries.
 * - /spaces/{spaceId}/questions/{questionId}: Help tab Q&A questions.
 * - /spaces/{spaceId}/conversations/{conversationId}: Chat tab conversations.
 * - /spaces/{spaceId}/chatHistory/{chatId}: Ask tab AI conversation history.
 *
 * Key Security Decisions:
 * - Users can only read/write their own user document.
 * - Anyone authenticated can read space metadata (for joining via Space ID).
 * - Only space members can access space data (entries, summaries, questions, etc.).
 * - Membership is checked via the /spaces/{spaceId}/members/{userId} subcollection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============ HELPER FUNCTIONS ============

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user owns a document (by userId)
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if user is a member of a space (via members subcollection)
    function isSpaceMember(spaceId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/spaces/$(spaceId)/members/$(request.auth.uid));
    }

    // ============ USERS COLLECTION ============
    // Users can only read/write their own user document
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Cannot list all users
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false; // Users cannot delete accounts directly
    }

    // ============ SPACES COLLECTION ============
    // Anyone authenticated can read space metadata (to verify Space ID during join)
    // Spaces are created by admins only (or via scripts)
    match /spaces/{spaceId} {
      allow get, list: if isAuthenticated();
      allow create: if false; // Spaces created via admin/scripts only
      allow update: if isSpaceMember(spaceId);
      allow delete: if false; // Spaces cannot be deleted

      // ============ MEMBERS SUBCOLLECTION ============
      // Space members can read all members
      // Users can create their own membership (when joining)
      // Users can update only their own membership
      match /members/{userId} {
        allow get: if isSpaceMember(spaceId) || isOwner(userId);
        allow list: if isSpaceMember(spaceId);
        allow create: if isOwner(userId); // Can join by creating own membership
        allow update: if isOwner(userId);
        allow delete: if false; // Cannot leave spaces for now
      }

      // ============ ENTRIES SUBCOLLECTION ============
      // All space members can read entries
      // Members can create entries with their own userId
      // Only entry creator can update/delete
      match /entries/{entryId} {
        allow get, list: if isSpaceMember(spaceId);
        allow create: if isSpaceMember(spaceId) &&
          request.resource.data.createdBy == request.auth.uid;
        allow update: if isSpaceMember(spaceId) &&
          resource.data.createdBy == request.auth.uid;
        allow delete: if isSpaceMember(spaceId) &&
          resource.data.createdBy == request.auth.uid;
      }

      // ============ SUMMARIES SUBCOLLECTION ============
      // All space members can read/write summaries
      // Summaries cannot be deleted (system-managed)
      match /summaries/{summaryId} {
        allow get, list: if isSpaceMember(spaceId);
        allow create: if isSpaceMember(spaceId);
        allow update: if isSpaceMember(spaceId);
        allow delete: if false;
      }

      // ============ QUESTIONS SUBCOLLECTION (Help Tab) ============
      // All space members can read questions
      // Members can create questions with their own userId
      // Questions can be updated (for adding answers, votes)
      match /questions/{questionId} {
        allow get, list: if isSpaceMember(spaceId);
        allow create: if isSpaceMember(spaceId) &&
          request.resource.data.askedBy == request.auth.uid;
        allow update: if isSpaceMember(spaceId);
        allow delete: if isSpaceMember(spaceId) &&
          resource.data.askedBy == request.auth.uid;
      }

      // ============ CONVERSATIONS SUBCOLLECTION (Chat Tab) ============
      // Only participants can access their conversations
      match /conversations/{conversationId} {
        allow get: if isSpaceMember(spaceId) &&
          request.auth.uid in resource.data.participants;
        allow list: if isSpaceMember(spaceId);
        allow create: if isSpaceMember(spaceId) &&
          request.auth.uid in request.resource.data.participants;
        allow update: if isSpaceMember(spaceId) &&
          request.auth.uid in resource.data.participants;
        allow delete: if false;

        // Messages within conversations
        match /messages/{messageId} {
          allow get, list: if isSpaceMember(spaceId);
          allow create: if isSpaceMember(spaceId) &&
            request.resource.data.senderId == request.auth.uid;
          allow update: if false; // Messages cannot be edited
          allow delete: if false; // Messages cannot be deleted
        }
      }

      // ============ CHAT HISTORY SUBCOLLECTION (Ask Tab) ============
      // Users can only access their own chat history
      match /chatHistory/{chatId} {
        allow get: if isSpaceMember(spaceId) &&
          resource.data.userId == request.auth.uid;
        allow list: if isSpaceMember(spaceId);
        allow create: if isSpaceMember(spaceId) &&
          request.resource.data.userId == request.auth.uid;
        allow update: if isSpaceMember(spaceId) &&
          resource.data.userId == request.auth.uid;
        allow delete: if isSpaceMember(spaceId) &&
          resource.data.userId == request.auth.uid;
      }
    }
  }
}
